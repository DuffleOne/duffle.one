---
kind: pipeline
type: docker
name: build and publish

steps:
  - name: build_site
    image: node:20
    volumes:
      - name: build
        path: /build
    commands:
      - npm ci
      - npm run build

  - name: publish_development
    image: amazon/aws-cli
    volumes:
      - name: build
        path: /build
      - name: aws
        path: /root/.aws
    commands:
      - aws s3 sync /build s3://duffle.one/dev --acl public-read --follow-symlinks
    depends_on:
      - build_site
    when:
      event:
        - push

  - name: publish production
    image: amazon/aws-cli
    volumes:
      - name: build
        path: /build
      - name: aws
        path: /root/.aws
    commands:
      - aws s3 sync /build s3://duffle.one --acl public-read --follow-symlinks --delete
      - aws s3 cp /build/index.html s3://duffle.one/index.html --acl public-read --content-type text/html --cache-control "no-cache, no-store, must-revalidate" --metadata-directive REPLACE
      - aws s3 cp /build/404.html s3://duffle.one/404.html --acl public-read --content-type text/html --cache-control "no-cache, no-store, must-revalidate" --metadata-directive REPLACE
    depends_on:
      - build_site
      - publish_development
    when:
      branch:
        - master
      event:
        - push

volumes:
  - name: build
    temp: {}
  - name: aws
    host:
      path: /root/.aws
---
kind: signature
hmac: ba752d85fede159ce58aaafc0582e4ad85a199036bedfa07e49c7726936de8c6
